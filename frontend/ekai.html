<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EkaiControlPlane</title>
  <script type="importmap">
  {
    "imports": {
      "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js"
    }
  }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #0f172a; color: #e2e8f0; }
    h1 { text-align: center; color: #f8fafc; margin-bottom: 24px; }
    .tabs { display: flex; gap: 4px; margin-bottom: 0; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: #1e293b; border: 1px solid #334155; color: #94a3b8; cursor: pointer; border-radius: 8px 8px 0 0; border-bottom: none; transition: all 0.2s; }
    .tab:hover { background: #334155; color: #e2e8f0; }
    .tab.active { background: #1e293b; color: #38bdf8; border-color: #38bdf8; border-bottom: 1px solid #1e293b; margin-bottom: -1px; z-index: 1; }
    .panel { display: none; background: #1e293b; padding: 20px; border-radius: 0 8px 8px 8px; border: 1px solid #334155; }
    .panel.active { display: block; }
    .section { background: #0f172a; padding: 16px; margin: 12px 0; border-radius: 8px; border: 1px solid #334155; }
    .section h4 { margin: 0 0 12px 0; color: #f1f5f9; font-size: 15px; }

    button { padding: 10px 18px; margin: 4px 2px; cursor: pointer; border: none; border-radius: 6px; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #475569; color: white; }
    .btn-secondary:hover { background: #64748b; }
    button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }

    input, select { padding: 10px 12px; margin: 4px 0; width: 100%; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; }
    input::placeholder { color: #64748b; }
    select { cursor: pointer; }

    label { display: block; margin-top: 10px; font-weight: 500; font-size: 13px; color: #94a3b8; }
    .row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 180px; }

    .status { padding: 12px; margin: 12px 0; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; word-break: break-all; }
    .success { background: #052e16; color: #4ade80; border: 1px solid #166534; }
    #globalSuccess { font-size: 16px; font-weight: 600; padding: 16px; text-align: center; }
    .error { background: #2d0a0a; color: #f87171; border: 1px solid #7f1d1d; }
    .info { background: #0c1929; color: #60a5fa; border: 1px solid #1e40af; }
    .warn { background: #1c1a05; color: #fbbf24; border: 1px solid #854d0e; }

    pre { background: #020617; color: #a5f3fc; padding: 16px; border-radius: 6px; overflow-x: auto; font-size: 12px; white-space: pre-wrap; word-break: break-all; border: 1px solid #1e293b; }
    .log { max-height: 300px; overflow-y: auto; }

    .header { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 16px; border-radius: 8px; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; border: 1px solid #334155; }
    .header-info { font-size: 15px; color: #94a3b8; }
    .header-info code { color: #38bdf8; cursor: pointer; }
    .header-info code:hover { text-decoration: underline; }
    .connected { color: #4ade80; font-weight: 500; }

    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; font-weight: 500; }
    .badge.owner { background: #854d0e; color: #fef3c7; }
    .badge.user { background: #164e63; color: #a5f3fc; }

    .contract-input { display: flex; gap: 10px; margin: 16px 0; }
    .contract-input input { flex: 1; }
    .contract-input button { white-space: nowrap; }

    .provider-select { display: flex; gap: 8px; align-items: flex-end; }
    .provider-select select { flex: 1; }

    .hint { font-size: 12px; color: #64748b; margin: 4px 0 8px 0; }
  </style>
</head>
<body>
  <h1>EkaiControlPlane</h1>

  <div class="header">
    <div>
      <button id="connectBtn" class="btn-primary">Connect MetaMask</button>
      <span id="walletStatus" style="margin-left: 12px;">Not connected</span>
    </div>
    <div class="header-info">
      <div>Network: <span id="networkName">-</span></div>
      <div>Contract: <code id="contractAddr" title="Click to open in explorer">-</code></div>
    </div>
  </div>


  <div id="networkWarning" class="status warn" style="display: none; cursor: pointer;" title="Click to switch network">Not connected to Sapphire Testnet - Click here or Connect to switch</div>
  <div id="globalError" class="status error" style="display: none; cursor: pointer;" title="Click to dismiss"></div>
  <div id="globalSuccess" class="status success" style="display: none; cursor: pointer;" title="Click to dismiss"></div>

  <div class="tabs">
    <button class="tab active" data-panel="secrets">Secrets</button>
    <button class="tab" data-panel="delegates">Delegates</button>
    <button class="tab" data-panel="models">Models</button>
    <button class="tab" data-panel="views">Views</button>
    <button class="tab" data-panel="admin">Admin</button>
  </div>

  <!-- Admin Panel -->
  <div id="admin" class="panel">
    <div id="notAdminWarning" class="status warn" style="display: none; font-size: 14px;">
      You are not the contract owner. Admin functions are disabled.<br>
      Contact the contract owner to make changes.
    </div>

    <div class="section">
      <h4>Contract Info</h4>
      <button id="getInfoBtn" class="btn-secondary">Refresh</button>
      <pre id="contractInfo">Loading...</pre>
    </div>

    <div class="section">
      <h4>Valid Providers</h4>
      <button id="checkAllProvidersBtn" class="btn-secondary">Refresh</button>
      <div id="providersList" class="status info" style="margin-top: 12px;">Loading...</div>
    </div>

    <div id="adminControls">
      <div class="section">
        <h4>Set Gateway <span class="badge owner">Owner</span></h4>
        <label>Gateway Address:</label>
        <input type="text" id="gatewayAddr" placeholder="0x...">
        <button id="setGatewayBtn" class="btn-primary">Set Gateway</button>
      </div>

      <div class="section">
        <h4>Set ROFL Key <span class="badge owner">Owner</span></h4>
        <div class="row">
          <div>
            <label>Public Key (hex):</label>
            <input type="text" id="roflPubkey" placeholder="0x..." value="0x0000000000000000000000000000000000000000000000000000000000000000">
          </div>
          <div style="min-width: 100px;">
            <label>Version:</label>
            <input type="number" id="roflVersion" value="1" min="1">
          </div>
        </div>
        <label style="margin-top: 12px;"><input type="checkbox" id="roflActive" checked> Active</label>
        <button id="setRoflKeyBtn" class="btn-primary">Set ROFL Key</button>
      </div>

      <div class="section">
        <h4>Manage Providers <span class="badge owner">Owner</span></h4>
        <label>Provider:</label>
        <select id="providerName">
          <option value="ANTHROPIC">ANTHROPIC</option>
          <option value="OPENAI">OPENAI</option>
          <option value="GOOGLE">GOOGLE</option>
          <option value="XAI">XAI</option>
          <option value="OPENROUTER">OPENROUTER</option>
          <option value="GROQ">GROQ</option>
        </select>
        <div style="margin-top: 12px;">
          <button id="addProviderBtn" class="btn-success">Add Provider</button>
          <button id="removeProviderBtn" class="btn-danger">Remove Provider</button>
          <button id="addAllProvidersBtn" class="btn-primary">Add All Providers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Secrets Panel -->
  <div id="secrets" class="panel active">
    <div class="section">
      <h4>Set Secret <span class="badge user">User</span></h4>
      <label>Provider:</label>
      <select id="secretProvider">
        <option value="ANTHROPIC">ANTHROPIC</option>
        <option value="OPENAI">OPENAI</option>
        <option value="GOOGLE">GOOGLE</option>
        <option value="XAI">XAI</option>
        <option value="OPENROUTER">OPENROUTER</option>
        <option value="GROQ">GROQ</option>
      </select>
      <label>Secret:</label>
      <input type="password" id="secretValue" placeholder="sk-...">
      <button id="setSecretBtn" class="btn-success">Set Secret</button>
    </div>

    <div class="section">
      <h4>Revoke Secret <span class="badge user">User</span></h4>
      <label>Provider:</label>
      <select id="revokeProvider">
        <option value="ANTHROPIC">ANTHROPIC</option>
        <option value="OPENAI">OPENAI</option>
        <option value="GOOGLE">GOOGLE</option>
        <option value="XAI">XAI</option>
        <option value="OPENROUTER">OPENROUTER</option>
        <option value="GROQ">GROQ</option>
      </select>
      <button id="revokeSecretBtn" class="btn-danger">Revoke Secret</button>
    </div>
  </div>

  <!-- Delegates Panel -->
  <div id="delegates" class="panel">
    <div class="section">
      <h4>Add Delegate <span class="badge user">User</span></h4>
      <p class="hint">Delegates can access ALL your secrets across all providers</p>
      <label>Delegate Address:</label>
      <input type="text" id="addDelegateAddr" placeholder="0x...">
      <button id="addDelegateBtn" class="btn-success">Add Delegate</button>
    </div>

    <div class="section">
      <h4>Remove Delegate <span class="badge user">User</span></h4>
      <label>Delegate Address:</label>
      <input type="text" id="removeDelegateAddr" placeholder="0x...">
      <button id="removeDelegateBtn" class="btn-danger">Remove Delegate</button>
    </div>

    <div class="section">
      <h4>Can they access my secrets?</h4>
      <p class="hint">Check if an address is your delegate</p>
      <label>Address to check:</label>
      <input type="text" id="checkMyDelegateAddr" placeholder="0x...">
      <button id="checkMyDelegateBtn" class="btn-secondary">Check</button>
      <div id="myDelegateResult" class="status info">-</div>
    </div>

    <div class="section">
      <h4>Can I access their secrets?</h4>
      <p class="hint">Check if you're a delegate for an owner</p>
      <label>Owner address:</label>
      <input type="text" id="checkImDelegateOwner" placeholder="0x...">
      <button id="checkImDelegateBtn" class="btn-secondary">Check</button>
      <div id="imDelegateResult" class="status info">-</div>
    </div>
  </div>

  <!-- Models Panel -->
  <div id="models" class="panel">
    <div class="section">
      <h4>Add Allowed Model <span class="badge user">User</span></h4>
      <p class="hint">If no models added for a provider, ALL models are allowed</p>
      <div class="row">
        <div>
          <label>Provider:</label>
          <select id="addModelProvider">
            <option value="ANTHROPIC">ANTHROPIC</option>
            <option value="OPENAI">OPENAI</option>
            <option value="GOOGLE">GOOGLE</option>
            <option value="XAI">XAI</option>
            <option value="OPENROUTER">OPENROUTER</option>
            <option value="GROQ">GROQ</option>
          </select>
        </div>
        <div>
          <label>Model:</label>
          <input type="text" id="addModelName" placeholder="gpt-4, claude-3-opus, etc.">
        </div>
      </div>
      <button id="addModelBtn" class="btn-success">Add Model</button>
    </div>

    <div class="section">
      <h4>Remove Allowed Model <span class="badge user">User</span></h4>
      <div class="row">
        <div>
          <label>Provider:</label>
          <select id="removeModelProvider">
            <option value="ANTHROPIC">ANTHROPIC</option>
            <option value="OPENAI">OPENAI</option>
            <option value="GOOGLE">GOOGLE</option>
            <option value="XAI">XAI</option>
            <option value="OPENROUTER">OPENROUTER</option>
            <option value="GROQ">GROQ</option>
          </select>
        </div>
        <div>
          <label>Model:</label>
          <input type="text" id="removeModelName" placeholder="gpt-4">
        </div>
      </div>
      <button id="removeModelBtn" class="btn-danger">Remove Model</button>
    </div>

    <div class="section">
      <h4>Check Model Permission</h4>
      <div class="row">
        <div>
          <label>Owner:</label>
          <input type="text" id="checkModelOwner" placeholder="0x...">
        </div>
        <div>
          <label>Provider:</label>
          <select id="checkModelProvider">
            <option value="ANTHROPIC">ANTHROPIC</option>
            <option value="OPENAI">OPENAI</option>
            <option value="GOOGLE">GOOGLE</option>
            <option value="XAI">XAI</option>
            <option value="OPENROUTER">OPENROUTER</option>
            <option value="GROQ">GROQ</option>
          </select>
        </div>
        <div>
          <label>Model:</label>
          <input type="text" id="checkModelName" placeholder="gpt-4">
        </div>
      </div>
      <button id="checkModelBtn" class="btn-secondary">Check Permission</button>
      <div id="modelResult" class="status info">-</div>
    </div>
  </div>

  <!-- Views Panel -->
  <div id="views" class="panel">
    <div class="section">
      <h4>Get Secret Ciphertext</h4>
      <div class="row">
        <div>
          <label>Owner:</label>
          <input type="text" id="viewSecretOwner" placeholder="0x...">
        </div>
        <div>
          <label>Provider:</label>
          <select id="viewSecretProvider">
            <option value="ANTHROPIC">ANTHROPIC</option>
            <option value="OPENAI">OPENAI</option>
            <option value="GOOGLE">GOOGLE</option>
            <option value="XAI">XAI</option>
            <option value="OPENROUTER">OPENROUTER</option>
            <option value="GROQ">GROQ</option>
          </select>
        </div>
      </div>
      <button id="getSecretBtn" class="btn-primary">Get Secret</button>
      <pre id="secretResult">-</pre>
    </div>

    <div class="section">
      <h4>My Secrets</h4>
      <button id="refreshMySecretsBtn" class="btn-secondary">Refresh</button>
      <pre id="mySecretsStatus" class="status info" style="white-space: pre-line;">Connect wallet to view</pre>
    </div>
  </div>


  <script type="module">
    import { ethers } from 'ethers';

    // ============ Config ============
    const PROVIDERS = ['ANTHROPIC', 'OPENAI', 'GOOGLE', 'XAI', 'OPENROUTER', 'GROQ'];

    // Config loaded from ../config.json
    const NETWORK = 'sapphire-testnet';

    async function loadConfig() {
      try {
        const res = await fetch('../config.json');
        const config = await res.json();
        const netConfig = config.networks[NETWORK];
        const contractConfig = config.contracts[NETWORK];

        NET = {
          chainId: netConfig.chainId,
          name: NETWORK.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
          rpc: netConfig.rpcUrl,
          explorer: netConfig.explorer,
          contract: contractConfig.EkaiControlPlane
        };

        initApp();
      } catch (e) {
        console.error('Failed to load config.json:', e);
        document.body.innerHTML = '<h1 style="color: #f87171;">Failed to load ../config.json</h1>';
      }
    }

    const ABI = [
      "function owner() view returns (address)",
      "function gateway() view returns (address)",
      "function getRoflKey() view returns (bytes pubkey, uint64 version, bool active)",
      "function setGateway(address)",
      "function setRoflKey(bytes, uint64, bool)",
      "function addProvider(bytes32)",
      "function removeProvider(bytes32)",
      "function isValidProvider(bytes32) view returns (bool)",
      "function setSecret(bytes32, bytes)",
      "function revokeSecret(bytes32)",
      "function getSecretCiphertext(address, bytes32) view returns (bytes, uint64, bool, uint64)",
      "function addDelegate(address)",
      "function removeDelegate(address)",
      "function isDelegatePermitted(address, address) view returns (bool)",
      "function delegateCount(address) view returns (uint32)",
      "function addAllowedModel(bytes32, bytes32)",
      "function removeAllowedModel(bytes32, bytes32)",
      "function isModelPermitted(address, bytes32, bytes32) view returns (bool)",
      "function modelCount(address, bytes32) view returns (uint32)"
    ];

    // ============ Helpers ============
    const $ = id => document.getElementById(id);
    const toId = name => ethers.keccak256(ethers.toUtf8Bytes(name.toUpperCase()));

    let NET, readProvider, readContract;
    let provider, signer, contract, userAddress;
    let userSecrets = {}; // Track which providers have secrets: { OPENAI: true, ... }
    let isOwner = false; // Track if current user is contract owner

    function log(msg) {
      console.log(msg);
    }

    function status(id, msg, type) {
      const el = $(id);
      if (el) { el.textContent = msg; el.className = `status ${type}`; }
    }

    function showError(msg) {
      const el = $('globalError');
      el.textContent = msg;
      el.style.display = 'block';
      el.onclick = () => el.style.display = 'none';
    }

    function hideError() {
      $('globalError').style.display = 'none';
    }

    function showSuccess(msg) {
      const el = $('globalSuccess');
      el.textContent = msg;
      el.style.display = 'block';
      el.onclick = () => el.style.display = 'none';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    function hideSuccess() {
      $('globalSuccess').style.display = 'none';
    }

    async function refreshUserSecrets() {
      if (!contract || !userAddress) return;
      userSecrets = {};
      for (const prov of PROVIDERS) {
        try {
          const [, , exists] = await contract.getSecretCiphertext(userAddress, toId(prov));
          userSecrets[prov] = exists;
        } catch (e) {
          userSecrets[prov] = false;
        }
      }
      updateModelDropdowns();
      updateMySecretsView();
    }

    function updateModelDropdowns() {
      const providersWithSecrets = PROVIDERS.filter(p => userSecrets[p]);
      const dropdowns = ['addModelProvider', 'removeModelProvider'];

      for (const id of dropdowns) {
        const select = $(id);
        select.innerHTML = '';
        if (providersWithSecrets.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No secrets set';
          opt.disabled = true;
          select.appendChild(opt);
        } else {
          for (const prov of providersWithSecrets) {
            const opt = document.createElement('option');
            opt.value = prov;
            opt.textContent = prov;
            select.appendChild(opt);
          }
        }
      }

      // Show/hide hint message
      const modelsPanel = $('models');
      let noSecretsMsg = modelsPanel.querySelector('.no-secrets-msg');
      if (providersWithSecrets.length === 0) {
        if (!noSecretsMsg) {
          noSecretsMsg = document.createElement('div');
          noSecretsMsg.className = 'status warn no-secrets-msg';
          noSecretsMsg.textContent = 'Set a secret first in the Secrets tab';
          modelsPanel.insertBefore(noSecretsMsg, modelsPanel.firstChild);
        }
      } else if (noSecretsMsg) {
        noSecretsMsg.remove();
      }
    }

    function updateMySecretsView() {
      const container = $('mySecretsStatus');
      if (!container) return;

      if (!userAddress) {
        container.textContent = 'Connect wallet to view';
        container.className = 'status info';
        return;
      }

      const lines = PROVIDERS.map(prov => {
        const has = userSecrets[prov];
        return `${prov}: ${has ? '\u2713' : '\u2717'}`;
      });
      container.textContent = lines.join('\n');
      container.className = 'status info';
    }

    async function tx(name, promise, successMsg) {
      hideError();
      hideSuccess();
      try {
        log(`${name}: sending...`);
        const t = await promise;
        log(`${name}: waiting... ${t.hash}`);
        await t.wait();
        log(`${name}: confirmed!`);
        if (successMsg) showSuccess(successMsg);
        return true;
      } catch (e) {
        const msg = e.reason || e.message;
        log(`${name}: ERROR - ${msg}`);
        showError(`${name}: ${msg}`);
        return false;
      }
    }

    // ============ Tabs ============
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        $(tab.dataset.panel).classList.add('active');
      };
    });

    // ============ Connect ============
    async function updateAccount(addr) {
      userAddress = addr;
      $('walletStatus').innerHTML = `<span class="connected">${userAddress.slice(0,6)}...${userAddress.slice(-4)}</span>`;
      $('checkModelOwner').value = userAddress;
      $('viewSecretOwner').value = userAddress;
      contract = new ethers.Contract(NET.contract, ABI, signer);
      log(`Account: ${userAddress}`);
      $('getInfoBtn').click();
      $('checkAllProvidersBtn').click();
      refreshUserSecrets();
    }

    // Set up MetaMask event listeners on page load
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', async (accounts) => {
        if (accounts.length === 0) {
          $('walletStatus').textContent = 'Disconnected';
          userAddress = null;
          contract = null;
          return;
        }
        // Account changed - need to reconnect
        $('walletStatus').innerHTML = `<span style="color: #fbbf24;">Account changed - click Connect</span>`;
        userAddress = null;
        contract = null;
      });

      window.ethereum.on('chainChanged', () => {
        window.location.reload();
      });
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) throw new Error('MetaMask not found');

        // First switch to Sapphire network
        try {
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: NET.chainId }] });
        } catch (e) {
          if (e.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{ chainId: NET.chainId, chainName: NET.name, rpcUrls: [NET.rpc], nativeCurrency: { name: 'ROSE', symbol: 'ROSE', decimals: 18 }, blockExplorerUrls: [NET.explorer] }]
            });
          } else throw e;
        }

        // Request permission - this prompts user to select/connect account
        await window.ethereum.request({
          method: 'wallet_requestPermissions',
          params: [{ eth_accounts: {} }]
        });

        // Now get the connected accounts
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length === 0) throw new Error('No account selected');

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        await updateAccount(accounts[0]);
      } catch (e) {
        log(`Connect error: ${e.message}`);
        showError(e.message);
      }
    }

    $('connectBtn').onclick = connectWallet;

    // ============ Info ============
    let contractOwner = null;

    function updateAdminUI() {
      const adminControls = $('adminControls');
      const warning = $('notAdminWarning');

      if (!userAddress) {
        // Not connected - hide admin controls, show connect prompt
        warning.style.display = 'block';
        warning.innerHTML = 'Connect your wallet to see if you have admin access.';
        adminControls.style.display = 'none';
      } else if (isOwner) {
        // Is owner - show admin controls
        warning.style.display = 'none';
        adminControls.style.display = 'block';
      } else {
        // Connected but not owner - show warning, hide controls
        warning.style.display = 'block';
        const ownerDisplay = contractOwner ? `<br>Owner: <code style="color: #38bdf8;">${contractOwner}</code>` : '';
        warning.innerHTML = `You are not the contract owner. Admin functions are disabled.${ownerDisplay}`;
        adminControls.style.display = 'none';
      }
    }

    $('getInfoBtn').onclick = async () => {
      try {
        const [owner, gateway, rofl] = await Promise.all([
          readContract.owner(), readContract.gateway(), readContract.getRoflKey()
        ]);

        // Update owner status
        contractOwner = owner;
        isOwner = userAddress ? owner.toLowerCase() === userAddress.toLowerCase() : false;
        updateAdminUI();

        $('contractInfo').textContent = JSON.stringify({
          owner,
          isOwner: userAddress ? isOwner : '(connect wallet)',
          gateway: gateway || '(not set)',
          roflKey: { pubkey: rofl[0], version: rofl[1].toString(), active: rofl[2] }
        }, null, 2);
      } catch (e) {
        $('contractInfo').textContent = `Error: ${e.message}`;
      }
    };

    // ============ Admin ============
    $('setGatewayBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const addr = $('gatewayAddr').value.trim();
      if (!ethers.isAddress(addr)) return showError('Invalid address');
      if (await tx('setGateway', contract.setGateway(addr))) $('getInfoBtn').click();
    };

    $('setRoflKeyBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const pubkey = $('roflPubkey').value.trim() || '0x';
      const version = parseInt($('roflVersion').value) || 1;
      const active = $('roflActive').checked;
      if (await tx('setRoflKey', contract.setRoflKey(pubkey, version, active))) $('getInfoBtn').click();
    };

    $('addProviderBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const name = $('providerName').value;
      await tx(`addProvider(${name})`, contract.addProvider(toId(name)));
    };

    $('removeProviderBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const name = $('providerName').value;
      await tx(`removeProvider(${name})`, contract.removeProvider(toId(name)));
    };

    $('addAllProvidersBtn').onclick = async () => {
      if (!contract) return showError('Load contract first');
      for (const name of PROVIDERS) {
        try {
          const valid = await contract.isValidProvider(toId(name));
          if (!valid) {
            await tx(`addProvider(${name})`, contract.addProvider(toId(name)));
          } else {
            log(`${name} already added`);
          }
        } catch (e) {
          log(`${name}: ${e.reason || e.message}`);
        }
      }
      $('checkAllProvidersBtn').click();
    };

    $('checkAllProvidersBtn').onclick = async () => {
      const results = [];
      for (const name of PROVIDERS) {
        try {
          const valid = await readContract.isValidProvider(toId(name));
          results.push(`${name}: ${valid ? '✓' : '✗'}`);
        } catch (e) {
          results.push(`${name}: error`);
        }
      }
      status('providersList', results.join('  |  '), 'info');
    };

    // ============ Secrets ============
    $('setSecretBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const prov = $('secretProvider').value;
      const secret = $('secretValue').value;
      if (!secret) return showError('Enter secret');
      if (await tx(`setSecret(${prov})`, contract.setSecret(toId(prov), ethers.toUtf8Bytes(secret)), `Secret saved for ${prov}`)) {
        $('secretValue').value = '';
        await refreshUserSecrets();
      }
    };

    $('revokeSecretBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const prov = $('revokeProvider').value;
      if (await tx(`revokeSecret(${prov})`, contract.revokeSecret(toId(prov)), `Secret revoked for ${prov}`)) {
        await refreshUserSecrets();
      }
    };

    // ============ Delegates ============
    $('addDelegateBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const addr = $('addDelegateAddr').value.trim();
      if (!ethers.isAddress(addr)) return showError('Invalid address');
      if (await tx('addDelegate', contract.addDelegate(addr), 'Delegate added - they can now access your secrets')) {
        $('addDelegateAddr').value = '';
      }
    };

    $('removeDelegateBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const addr = $('removeDelegateAddr').value.trim();
      if (!ethers.isAddress(addr)) return showError('Invalid address');
      if (await tx('removeDelegate', contract.removeDelegate(addr), 'Delegate removed')) {
        $('removeDelegateAddr').value = '';
      }
    };

    // Check if someone is MY delegate (can they access my secrets?)
    $('checkMyDelegateBtn').onclick = async () => {
      if (!userAddress) return showError('Connect wallet first');
      const delegate = $('checkMyDelegateAddr').value.trim();
      if (!ethers.isAddress(delegate)) return showError('Invalid address');
      try {
        const permitted = await readContract.isDelegatePermitted(userAddress, delegate);
        const msg = permitted
          ? 'Yes - this address can access your secrets'
          : 'No - this address cannot access your secrets';
        status('myDelegateResult', msg, permitted ? 'success' : 'warn');
      } catch (e) {
        status('myDelegateResult', e.message, 'error');
      }
    };

    // Check if I am a delegate for someone (can I access their secrets?)
    $('checkImDelegateBtn').onclick = async () => {
      if (!userAddress) return showError('Connect wallet first');
      const owner = $('checkImDelegateOwner').value.trim();
      if (!ethers.isAddress(owner)) return showError('Invalid address');
      try {
        const permitted = await readContract.isDelegatePermitted(owner, userAddress);
        const msg = permitted
          ? 'Yes - you can access their secrets'
          : 'No - you cannot access their secrets';
        status('imDelegateResult', msg, permitted ? 'success' : 'warn');
      } catch (e) {
        status('imDelegateResult', e.message, 'error');
      }
    };

    // ============ Models ============
    $('addModelBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const prov = $('addModelProvider').value;
      if (!prov) return showError('No provider selected');
      const model = $('addModelName').value.trim();
      if (!model) return showError('Enter model name');
      if (await tx(`addAllowedModel(${prov}, ${model})`, contract.addAllowedModel(toId(prov), toId(model)), `Model restriction added for ${prov}`)) {
        $('addModelName').value = '';
      }
    };

    $('removeModelBtn').onclick = async () => {
      if (!contract) return showError('Load contract');
      const prov = $('removeModelProvider').value;
      if (!prov) return showError('No provider selected');
      const model = $('removeModelName').value.trim();
      if (!model) return showError('Enter model name');
      if (await tx(`removeAllowedModel(${prov}, ${model})`, contract.removeAllowedModel(toId(prov), toId(model)), 'Model restriction removed')) {
        $('removeModelName').value = '';
      }
    };

    $('checkModelBtn').onclick = async () => {
      const owner = $('checkModelOwner').value.trim();
      const prov = $('checkModelProvider').value;
      const model = $('checkModelName').value.trim();
      if (!ethers.isAddress(owner) || !model) return showError('Fill all fields');
      try {
        const [permitted, count] = await Promise.all([
          readContract.isModelPermitted(owner, toId(prov), toId(model)),
          readContract.modelCount(owner, toId(prov))
        ]);
        const msg = count == 0 ? `${permitted ? 'PERMITTED' : 'DENIED'} (no restrictions)` : `${permitted ? 'PERMITTED' : 'DENIED'} (${count} models whitelisted)`;
        status('modelResult', msg, permitted ? 'success' : 'warn');
      } catch (e) {
        status('modelResult', e.message, 'error');
      }
    };

    // ============ Views ============
    $('getSecretBtn').onclick = async () => {
      const owner = $('viewSecretOwner').value.trim();
      const prov = $('viewSecretProvider').value;
      if (!ethers.isAddress(owner)) return showError('Invalid owner address');
      try {
        const [ciphertext, secretVer, exists, roflVer] = await readContract.getSecretCiphertext(owner, toId(prov));
        if (!exists) {
          $('secretResult').textContent = `No secret set for ${prov}\n\nThis address has not stored a secret for this provider yet.\nGo to the Secrets tab to set one.`;
          $('secretResult').className = 'status warn';
        } else {
          $('secretResult').textContent = JSON.stringify({
            exists: true,
            secretVersion: secretVer.toString(),
            roflKeyVersion: roflVer.toString(),
            ciphertext: ciphertext,
            decoded: ethers.toUtf8String(ciphertext)
          }, null, 2);
          $('secretResult').className = '';
        }
      } catch (e) {
        $('secretResult').textContent = `Error: ${e.message}`;
      }
    };

    $('refreshMySecretsBtn').onclick = async () => {
      if (!contract) return showError('Connect wallet first');
      await refreshUserSecrets();
    };

    // ============ Init App (called after config loads) ============
    function initApp() {
      // Set up read-only provider and contract
      readProvider = new ethers.JsonRpcProvider(NET.rpc);
      readContract = new ethers.Contract(NET.contract, ABI, readProvider);

      // Update UI with network info
      $('networkName').textContent = NET.name;
      $('contractAddr').textContent = `${NET.contract.slice(0,10)}...${NET.contract.slice(-6)}`;
      $('contractAddr').onclick = () => {
        window.open(`${NET.explorer}/address/${NET.contract}`, '_blank');
      };

      // Auto-load data
      updateAdminUI();
      $('getInfoBtn').click();
      $('checkAllProvidersBtn').click();

      // Check network
      checkNetwork();
    }

    async function checkNetwork() {
      if (!window.ethereum) return;
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== NET.chainId) {
          $('networkWarning').style.display = 'block';
        } else {
          $('networkWarning').style.display = 'none';
        }
      } catch (e) {
        console.log('Could not check network:', e.message);
      }
    }

    // Click network warning to switch
    $('networkWarning').onclick = async () => {
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: NET.chainId }] });
      } catch (e) {
        if (e.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: NET.chainId, chainName: NET.name, rpcUrls: [NET.rpc], nativeCurrency: { name: 'ROSE', symbol: 'ROSE', decimals: 18 }, blockExplorerUrls: [NET.explorer] }]
          });
        }
      }
    };

    // Load config and start app
    loadConfig();

  </script>
</body>
</html>
